<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SkipAD</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#e8f6ff; }
    #hud {
      position: fixed; top: 10px; left: 12px; right:12px;
      font: 14px/1.4 sans-serif; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      background: rgba(0,0,0,0.55); color:#fff; padding:10px 12px; border-radius:10px;
    }
    #hud b { font-weight:700; }
    #btn-reset, #ad-select, #file {
      background: rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.35);
      color:#fff; padding:4px 8px; border-radius:8px; font-size:12px;
    }
    #ad-select { cursor:pointer; }
    #toast {
      position:fixed; top:60px; left:12px; background:#000; color:#fff;
      padding:6px 10px; border-radius:8px; opacity:0; transition:opacity .25s;
      font: 13px/1.3 sans-serif;
    }
    canvas { display:block; }
    .spacer { flex:1; }
  </style>
</head>
<body>
  <div id="hud">
    Skips: <b id="skips">0</b>
    Best: <b id="best">0</b>
    <button id="btn-reset" title="로컬 최고기록 삭제">Reset Best</button>
    <span class="spacer"></span>
    Ad texture:
    <select id="ad-select" title="돌 표면에 그릴 이미지">
      <option value="none">None</option>
      <option value="skipbtn" selected>Skip Button (fake)</option>
      <option value="banner">Banner (fake)</option>
      <option value="upload">Upload…</option>
    </select>
    <input id="file" type="file" accept="image/*" style="display:none">
    <span style="opacity:.85">• Drag & release to throw</span>
  </div>
  <div id="toast"></div>
  <canvas id="c"></canvas>

  <script>
    // ---------- 캔버스/환경 ----------
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const skipsEl = document.getElementById('skips');
    const bestEl  = document.getElementById('best');
    const toastEl = document.getElementById('toast');
    const resetBtn = document.getElementById('btn-reset');
    const adSelect = document.getElementById('ad-select');
    const fileInput = document.getElementById('file');

    function fit() {
      canvas.width = innerWidth;
      canvas.height = innerHeight;
      waterY = Math.floor(canvas.height * 0.62);
    }
    addEventListener('resize', fit);
    let waterY = 0; fit();

    // ---------- 로컬 최고 기록 ----------
    const BEST_KEY = 'skipad_best_skips';
    function getBest(){ return Number(localStorage.getItem(BEST_KEY) || 0); }
    function setBest(v){ localStorage.setItem(BEST_KEY, String(v)); bestEl.textContent = v; }
    setBest(getBest());
    resetBtn.onclick = () => { localStorage.removeItem(BEST_KEY); setBest(0); showToast('Best reset'); };

    // ---------- 오디오(간단 효과음) ----------
    let audioCtx;
    function ping() {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(900, audioCtx.currentTime);
        o.frequency.exponentialRampToValueAtTime(450, audioCtx.currentTime + 0.08);
        g.gain.setValueAtTime(0.15, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.08);
        o.connect(g).connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.09);
      } catch(e) {}
    }

    // ---------- 가짜 광고 텍스처 (오프스크린 캔버스) ----------
    const tex = {
      skipbtn: makeSkipButtonTexture(),
      banner: makeBannerTexture(),
      upload: null // 사용자가 올린 이미지
    };

    function makeSkipButtonTexture(){
      const c = document.createElement('canvas'); c.width = 256; c.height = 128;
      const g = c.getContext('2d');
      // 빨간 바탕
      g.fillStyle = '#e53935'; roundRect(g, 8, 20, 240, 88, 22); g.fill();
      // ▶ 아이콘
      g.fillStyle = '#fff';
      g.beginPath(); g.moveTo(36, 44); g.lineTo(36, 100); g.lineTo(86, 72); g.closePath(); g.fill();
      // "SKIP AD"
      g.font = 'bold 34px system-ui, sans-serif';
      g.textAlign = 'left'; g.textBaseline = 'middle'; g.fillText('SKIP AD', 100, 64);
      return c;
    }

    function makeBannerTexture(){
      const c = document.createElement('canvas'); c.width = 256; c.height = 128;
      const g = c.getContext('2d');
      const grad = g.createLinearGradient(0,0,256,0);
      grad.addColorStop(0,'#4a90e2'); grad.addColorStop(1,'#50e3c2');
      g.fillStyle = grad; roundRect(g, 6, 16, 244, 96, 16); g.fill();
      g.fillStyle = 'rgba(255,255,255,0.9)';
      g.font = 'bold 28px system-ui, sans-serif';
      g.textAlign = 'center'; g.textBaseline = 'middle';
      g.fillText('AMAZING DEAL', 128, 56);
      g.font = 'bold 18px system-ui, sans-serif';
      g.fillText('Click? No. Throw!', 128, 88);
      return c;
    }

    function roundRect(g, x, y, w, h, r){
      g.beginPath();
      g.moveTo(x+r, y);
      g.arcTo(x+w, y,   x+w, y+h, r);
      g.arcTo(x+w, y+h, x,   y+h, r);
      g.arcTo(x,   y+h, x,   y,   r);
      g.arcTo(x,   y,   x+w, y,   r);
      g.closePath();
    }

    // 업로드 이미지 처리
    adSelect.addEventListener('change', () => {
      if (adSelect.value === 'upload') fileInput.click();
    });
    fileInput.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      const img = new Image();
      img.onload = () => {
        tex.upload = img;
        showToast('Image loaded. Try throwing!');
      };
      img.src = url;
    });

    // ---------- 입력/던지기 ----------
    let isDown = false, start = {x:0,y:0}, cur = {x:0,y:0};
    let stones = [];
    let skipCount = 0;
    let throwSkips = 0;

    const GRAV = 900;
    const RESTITUTION = 0.55;
    const FRICTION_X = 0.985;
    const WATER_DRAG = 0.88;
    const MIN_SPEED = 40;

    canvas.addEventListener('mousedown', (e) => {
      isDown = true;
      start = getPos(e);
      cur = {...start};
      throwSkips = 0;
    });
    canvas.addEventListener('mousemove', (e) => {
      if (isDown) cur = getPos(e);
    });
    addEventListener('mouseup', () => {
      if (!isDown) return;
      isDown = false;

      const vx = (start.x - cur.x) * 3;
      const vy = (start.y - cur.y) * 3;

      stones.push({
        x:start.x, y:start.y, r:10, vx, vy, alive:true, color:'#2a7de1',
        texture: currentTexture()
      });
    });

    function currentTexture(){
      const v = adSelect.value;
      if (v === 'none') return null;
      if (v === 'skipbtn') return tex.skipbtn;
      if (v === 'banner')  return tex.banner;
      if (v === 'upload')  return tex.upload || tex.skipbtn; // 업로드 전이면 기본
      return null;
    }

    function getPos(e){
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    // ---------- 루프 ----------
    let last = performance.now();
    function loop(now){
      const dt = Math.min(0.033, (now - last) / 1000);
      last = now;

      stones.forEach(s => {
        if (!s.alive) return;
        s.vy += GRAV * dt;
        s.x  += s.vx * dt;
        s.y  += s.vy * dt;

        if (s.y >= waterY) {
          if (s.vy > 0) { skipCount++; throwSkips++; skipsEl.textContent = skipCount; ping(); }
          s.y  = waterY - (s.y - waterY);
          s.vy = -Math.abs(s.vy) * RESTITUTION;
          s.vx *= WATER_DRAG;
        }

        s.vx *= FRICTION_X;

        const speed = Math.hypot(s.vx, s.vy);
        if (speed < MIN_SPEED && s.y >= waterY - 1) {
          s.alive = false;
          if (throwSkips > 0) {
            if (throwSkips > getBest()) { setBest(throwSkips); showToast(`New Best! ${throwSkips} skips 🎉`); }
            else showToast(`${throwSkips} skips`);
            throwSkips = 0;
          }
        }
      });

      draw();
      stones = stones.filter(s => s.alive || stones.length < 80);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ---------- 렌더 ----------
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const grad = ctx.createLinearGradient(0,0,0,canvas.height);
      grad.addColorStop(0,'#bfe5ff'); grad.addColorStop(0.6,'#e8f6ff');
      ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#9dd6ff'; ctx.fillRect(0, waterY, canvas.width, canvas.height - waterY);

      if (isDown) {
        ctx.strokeStyle = 'rgba(0,0,0,0.6)'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.lineTo(cur.x, cur.y); ctx.stroke();
        ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(start.x, start.y, 4, 0, Math.PI*2); ctx.fill();
      }

      stones.forEach(s => drawStone(s));
    }

    function drawStone(s){
      // 돌 타원
      ctx.save();
      ctx.translate(s.x, s.y);
      const a = s.r*1.2, b = s.r;
      // 타원 클리핑 경로
      ctx.beginPath();
      ctx.ellipse(0, 0, a, b, 0, 0, Math.PI*2);
      ctx.clip();

      // 배경(돌 색)
      ctx.fillStyle = s.color;
      ctx.fillRect(-a, -b, a*2, b*2);

      // 텍스처가 있으면 스케일 맞춰서 그리기
      if (s.texture) {
        // 텍스처를 타원 안에 맞추기
        const iw = s.texture.width || 256;
        const ih = s.texture.height || 128;
        // 타원의 가로세로 비율에 맞게 살짝 축소
        const scale = Math.min((a*2)/iw, (b*2)/ih) * 0.95;
        const w = iw * scale, h = ih * scale;
        ctx.drawImage(s.texture, -w/2, -h/2, w, h);
      }

      ctx.restore();

      // 가장자리 테두리
      ctx.strokeStyle = 'rgba(0,0,0,0.25)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.ellipse(s.x, s.y, a, b, 0, 0, Math.PI*2);
      ctx.stroke();
    }

    // ---------- 토스트 ----------
    let toastTimer;
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.opacity = 1;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.style.opacity = 0, 1200);
    }
  </script>
</body>
</html>
