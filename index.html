<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SkipAD</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#e8f6ff; }
    #hud {
      position: fixed; top: 10px; left: 12px; right:12px;
      font: 14px/1.4 system-ui, sans-serif; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      background: rgba(0,0,0,0.55); color:#fff; padding:10px 12px; border-radius:10px;
    }
    #hud b { font-weight:700; }
    #btn-reset, #ad-select, #file, #btn-submit, #btn-refresh {
      background: rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.35);
      color:#fff; padding:4px 8px; border-radius:8px; font-size:12px; cursor:pointer;
    }
    #ad-select { cursor:pointer; }
    #toast {
      position:fixed; top:60px; left:12px; background:#000; color:#fff;
      padding:6px 10px; border-radius:8px; opacity:0; transition:opacity .25s;
      font: 13px/1.3 sans-serif;
    }
    #leader {
      position: fixed; right: 12px; top: 72px; width: 240px;
      background: rgba(0,0,0,0.55); color:#fff; padding:10px 12px; border-radius:10px;
      font: 13px/1.4 system-ui, sans-serif;
    }
    #leader h3 { margin:0 0 6px 0; font-size:14px; }
    #leader ol { margin:6px 0 0 18px; padding:0; }
    #leader li { margin:2px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #name { width: 110px; padding:4px 6px; border-radius:8px; border:1px solid rgba(255,255,255,0.35); background:rgba(255,255,255,0.12); color:#fff; }
    canvas { display:block; }
    .spacer { flex:1; }
  </style>
</head>
<body>
  <div id="hud">
    Skips: <b id="skips">0</b>
    Best: <b id="best">0</b>
    <button id="btn-reset" title="Î°úÏª¨ ÏµúÍ≥†Í∏∞Î°ù ÏÇ≠Ï†ú">Reset Best</button>
    <span class="spacer"></span>
    Ad texture:
    <select id="ad-select" title="Îèå ÌëúÎ©¥Ïóê Í∑∏Î¶¥ Ïù¥ÎØ∏ÏßÄ">
      <option value="none">None</option>
      <option value="skipbtn" selected>Skip Button (fake)</option>
      <option value="banner">Banner (fake)</option>
      <option value="upload">Upload‚Ä¶</option>
    </select>
    <input id="file" type="file" accept="image/*" style="display:none">
    <span style="opacity:.85">‚Ä¢ Drag & release to throw</span>
  </div>

  <div id="leader">
    <h3>üèÜ Leaderboard (Top 10)</h3>
    <div style="display:flex; gap:6px; align-items:center; margin-bottom:6px">
      <input id="name" placeholder="nickname (opt)" maxlength="20">
      <button id="btn-submit" title="ÎßàÏßÄÎßâ Ï†êÏàò Ïò¨Î¶¨Í∏∞">Submit</button>
      <button id="btn-refresh" title="ÏÉàÎ°úÍ≥†Ïπ®">‚Üª</button>
    </div>
    <ol id="list"></ol>
    <div id="last" style="opacity:.85; margin-top:6px"></div>
  </div>

  <div id="toast"></div>
  <canvas id="c"></canvas>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // ===== Firebase Ï¥àÍ∏∞Ìôî =====
    // TODO: Ïó¨Í∏∞Ïóê ÎãπÏã†Ïùò firebaseConfig Î∂ôÏó¨ÎÑ£Í∏∞ (A-3 Îã®Í≥ÑÏóêÏÑú Î≥µÏÇ¨Ìïú Í∞ùÏ≤¥)
    const firebaseConfig = {
      // example:
      // apiKey: "‚Ä¶",
      // authDomain: "‚Ä¶",
      // databaseURL: "https://<your-db>.firebasedatabase.app",
      // projectId: "‚Ä¶",
      // storageBucket: "‚Ä¶",
      // messagingSenderId: "‚Ä¶",
      // appId: "‚Ä¶"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Ï∫îÎ≤ÑÏä§/ÌôòÍ≤Ω =====
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const skipsEl = document.getElementById('skips');
    const bestEl  = document.getElementById('best');
    const toastEl = document.getElementById('toast');
    const resetBtn = document.getElementById('btn-reset');
    const adSelect = document.getElementById('ad-select');
    const fileInput = document.getElementById('file');

    const listEl = document.getElementById('list');
    const nameEl = document.getElementById('name');
    const submitBtn = document.getElementById('btn-submit');
    const refreshBtn = document.getElementById('btn-refresh');
    const lastEl = document.getElementById('last');

    function fit() {
      canvas.width = innerWidth;
      canvas.height = innerHeight;
      waterY = Math.floor(canvas.height * 0.62);
    }
    addEventListener('resize', fit);
    let waterY = 0; fit();

    // ===== Î°úÏª¨ ÏµúÍ≥† Í∏∞Î°ù =====
    const BEST_KEY = 'skipad_best_skips';
    function getBest(){ return Number(localStorage.getItem(BEST_KEY) || 0); }
    function setBest(v){ localStorage.setItem(BEST_KEY, String(v)); bestEl.textContent = v; }
    setBest(getBest());
    resetBtn.onclick = () => { localStorage.removeItem(BEST_KEY); setBest(0); showToast('Best reset'); };

    // ===== Ïò§ÎîîÏò§ =====
    let audioCtx;
    function ping() {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(900, audioCtx.currentTime);
        o.frequency.exponentialRampToValueAtTime(450, audioCtx.currentTime + 0.08);
        g.gain.setValueAtTime(0.15, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.08);
        o.connect(g).connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.09);
      } catch(e) {}
    }

    // ===== Í∞ÄÏßú Í¥ëÍ≥† ÌÖçÏä§Ï≤ò =====
    const tex = {
      skipbtn: makeSkipButtonTexture(),
      banner: makeBannerTexture(),
      upload: null
    };

    function makeSkipButtonTexture(){
      const c = document.createElement('canvas'); c.width = 256; c.height = 128;
      const g = c.getContext('2d');
      g.fillStyle = '#e53935'; roundRect(g, 8, 20, 240, 88, 22); g.fill();
      g.fillStyle = '#fff';
      g.beginPath(); g.moveTo(36, 44); g.lineTo(36, 100); g.lineTo(86, 72); g.closePath(); g.fill();
      g.font = 'bold 34px system-ui, sans-serif';
      g.textAlign = 'left'; g.textBaseline = 'middle'; g.fillText('SKIP AD', 100, 64);
      return c;
    }
    function makeBannerTexture(){
      const c = document.createElement('canvas'); c.width = 256; c.height = 128;
      const g = c.getContext('2d');
      const grad = g.createLinearGradient(0,0,256,0);
      grad.addColorStop(0,'#4a90e2'); grad.addColorStop(1,'#50e3c2');
      g.fillStyle = grad; roundRect(g, 6, 16, 244, 96, 16); g.fill();
      g.fillStyle = 'rgba(255,255,255,0.9)';
      g.font = 'bold 28px system-ui, sans-serif';
      g.textAlign = 'center'; g.textBaseline = 'middle';
      g.fillText('AMAZING DEAL', 128, 56);
      g.font = 'bold 18px system-ui, sans-serif';
      g.fillText('Click? No. Throw!', 128, 88);
      return c;
    }
    function roundRect(g, x, y, w, h, r){
      g.beginPath();
      g.moveTo(x+r, y);
      g.arcTo(x+w, y,   x+w, y+h, r);
      g.arcTo(x+w, y+h, x,   y+h, r);
      g.arcTo(x,   y+h, x,   y,   r);
      g.arcTo(x,   y,   x+w, y,   r);
      g.closePath();
    }

    adSelect.addEventListener('change', () => {
      if (adSelect.value === 'upload') fileInput.click();
    });
    fileInput.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      const img = new Image();
      img.onload = () => { tex.upload = img; showToast('Image loaded. Try throwing!'); };
      img.src = url;
    });

    // ===== ÏûÖÎ†•/ÎçòÏßÄÍ∏∞ =====
    let isDown = false, start = {x:0,y:0}, cur = {x:0,y:0};
    let stones = [];
    let skipCount = 0;
    let throwSkips = 0;
    let lastScore = 0;

    const GRAV = 900, RESTITUTION = 0.55, FRICTION_X = 0.985, WATER_DRAG = 0.88, MIN_SPEED = 40;

    canvas.addEventListener('mousedown', (e) => {
      isDown = true;
      start = getPos(e);
      cur = {...start};
      throwSkips = 0;
    });
    canvas.addEventListener('mousemove', (e) => { if (isDown) cur = getPos(e); });
    addEventListener('mouseup', () => {
      if (!isDown) return;
      isDown = false;
      const vx = (start.x - cur.x) * 3;
      const vy = (start.y - cur.y) * 3;
      stones.push({ x:start.x, y:start.y, r:10, vx, vy, alive:true, color:'#2a7de1', texture: currentTexture() });
    });

    function currentTexture(){
      const v = adSelect.value;
      if (v === 'none') return null;
      if (v === 'skipbtn') return tex.skipbtn;
      if (v === 'banner')  return tex.banner;
      if (v === 'upload')  return tex.upload || tex.skipbtn;
      return null;
    }
    function getPos(e){
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    // ===== Î£®ÌîÑ =====
    let last = performance.now();
    function loop(now){
      const dt = Math.min(0.033, (now - last) / 1000); last = now;

      stones.forEach(s => {
        if (!s.alive) return;
        s.vy += GRAV * dt; s.x += s.vx * dt; s.y += s.vy * dt;

        if (s.y >= waterY) {
          if (s.vy > 0) { skipCount++; throwSkips++; skipsEl.textContent = skipCount; ping(); }
          s.y  = waterY - (s.y - waterY);
          s.vy = -Math.abs(s.vy) * RESTITUTION;
          s.vx *= WATER_DRAG;
        }
        s.vx *= FRICTION_X;

        const speed = Math.hypot(s.vx, s.vy);
        if (speed < MIN_SPEED && s.y >= waterY - 1) {
          s.alive = false;
          if (throwSkips > 0) {
            lastScore = throwSkips;
            lastEl.textContent = `Last: ${lastScore} skips`;
            if (throwSkips > getBest()) { setBest(throwSkips); showToast(`New Best! ${throwSkips} skips üéâ`); }
            else showToast(`${throwSkips} skips`);
            throwSkips = 0;
          }
        }
      });

      draw();
      stones = stones.filter(s => s.alive || stones.length < 80);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ===== Î†åÎçî =====
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const grad = ctx.createLinearGradient(0,0,0,canvas.height);
      grad.addColorStop(0,'#bfe5ff'); grad.addColorStop(0.6,'#e8f6ff');
      ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#9dd6ff'; ctx.fillRect(0, waterY, canvas.width, canvas.height - waterY);

      if (isDown) {
        ctx.strokeStyle = 'rgba(0,0,0,0.6)'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.lineTo(cur.x, cur.y); ctx.stroke();
        ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(start.x, start.y, 4, 0, Math.PI*2); ctx.fill();
      }

      stones.forEach(s => drawStone(s));
    }
    function drawStone(s){
      ctx.save(); ctx.translate(s.x, s.y);
      const a = s.r*1.2, b = s.r;
      ctx.beginPath(); ctx.ellipse(0, 0, a, b, 0, 0, Math.PI*2); ctx.clip();
      ctx.fillStyle = s.color; ctx.fillRect(-a, -b, a*2, b*2);
      if (s.texture) {
        const iw = s.texture.width || 256, ih = s.texture.height || 128;
        const scale = Math.min((a*2)/iw, (b*2)/ih) * 0.95;
        const w = iw * scale, h = ih * scale;
        ctx.drawImage(s.texture, -w/2, -h/2, w, h);
      }
      ctx.restore();
      ctx.strokeStyle = 'rgba(0,0,0,0.25)'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.ellipse(s.x, s.y, a, b, 0, 0, Math.PI*2); ctx.stroke();
    }

    // ===== ÌÜ†Ïä§Ìä∏ =====
    let toastTimer;
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.opacity = 1;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.style.opacity = 0, 1200);
    }

    // ===== Îû≠ÌÇπ: Ïì∞Í∏∞ & ÏùΩÍ∏∞ =====
    async function submitScore(){
      if (!lastScore || lastScore < 0) { showToast('No score to submit'); return; }
      const nickname = (nameEl.value || 'anon').trim().slice(0,20) || 'anon';
      const now = Date.now();
      try {
        await db.ref('scores').push({
          name: nickname,
          score: lastScore,
          at: now
        });
        showToast('Submitted!');
        await loadTop();
      } catch(e){
        console.error(e);
        showToast('Submit failed');
      }
    }

    async function loadTop(){
      // score ÏÉÅÏúÑ 10 (Realtime DBÎäî Ïó≠Ï†ïÎ†¨Ïù¥ ÏïΩÌï¥ atÏôÄ Ìï®Íªò Î∂àÎü¨ÏÑú Ï†ïÎ†¨ÌïòÎäî Î∞©Ïãù Îã§Ïñë)
      // Ïó¨Í∏∞ÏÑúÎäî score Í∏∞Ï§ÄÏúºÎ°ú Ìïú Î≤àÏóê Í∞ÄÏ†∏Ïò® Îí§, ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨‚ÜíÏÉÅÏúÑ10
      const snap = await db.ref('scores').limitToLast(100).get(); // ÏµúÍ∑º 100Í∞ú Í∞ÄÏ†∏ÏôÄ ÏÉÅÏúÑ ÏÑ†Î≥Ñ
      const rows = [];
      snap.forEach(ch => { rows.push(ch.val()); });
      rows.sort((a,b) => b.score - a.score || a.at - b.at);
      const top = rows.slice(0,10);

      listEl.innerHTML = '';
      top.forEach((r,i) => {
        const li = document.createElement('li');
        li.textContent = `${i+1}. ${r.name} ‚Äî ${r.score}`;
        listEl.appendChild(li);
      });
    }

    submitBtn.addEventListener('click', submitScore);
    refreshBtn.addEventListener('click', loadTop);
    loadTop();
  </script>
</body>
</html>
