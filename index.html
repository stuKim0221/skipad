<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SkipAD</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#e8f6ff; }
    #hud {
      position: fixed; top: 10px; left: 12px; font: 14px/1.4 sans-serif;
      background: rgba(0,0,0,0.55); color:#fff; padding:10px 12px; border-radius:10px;
      display:flex; gap:14px; align-items:center;
    }
    #hud b { font-weight:700; }
    #btn-reset {
      background: rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.35);
      color:#fff; padding:4px 8px; border-radius:8px; cursor:pointer; font-size:12px;
    }
    #toast {
      position:fixed; top:60px; left:12px; background:#000; color:#fff;
      padding:6px 10px; border-radius:8px; opacity:0; transition:opacity .25s;
      font: 13px/1.3 sans-serif;
    }
    canvas { display:block; }
  </style>
</head>
<body>
  <div id="hud">
    Skips: <b id="skips">0</b>
    Best: <b id="best">0</b>
    <button id="btn-reset" title="Î°úÏª¨ ÏµúÍ≥†Í∏∞Î°ù ÏÇ≠Ï†ú">Reset Best</button>
    <span style="opacity:.8">‚Ä¢ Drag & release to throw</span>
  </div>
  <div id="toast"></div>
  <canvas id="c"></canvas>

  <script>
    // ---------- Ï∫îÎ≤ÑÏä§/ÌôòÍ≤Ω ----------
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const skipsEl = document.getElementById('skips');
    const bestEl  = document.getElementById('best');
    const toastEl = document.getElementById('toast');
    const resetBtn = document.getElementById('btn-reset');

    function fit() {
      canvas.width = innerWidth;
      canvas.height = innerHeight;
      waterY = Math.floor(canvas.height * 0.62);
    }
    addEventListener('resize', fit);
    let waterY = 0; fit();

    // ---------- Î°úÏª¨ ÏµúÍ≥† Í∏∞Î°ù ----------
    const BEST_KEY = 'skipad_best_skips';
    function getBest(){ return Number(localStorage.getItem(BEST_KEY) || 0); }
    function setBest(v){ localStorage.setItem(BEST_KEY, String(v)); bestEl.textContent = v; }
    setBest(getBest());
    resetBtn.onclick = () => { localStorage.removeItem(BEST_KEY); setBest(0); showToast('Best reset'); };

    // ---------- Ïò§ÎîîÏò§(Í∞ÑÎã® Ìö®Í≥ºÏùå) ----------
    let audioCtx;
    function ping() {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(900, audioCtx.currentTime);
        o.frequency.exponentialRampToValueAtTime(450, audioCtx.currentTime + 0.08);
        g.gain.setValueAtTime(0.15, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.08);
        o.connect(g).connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.09);
      } catch(e) { /* Î™®Î∞îÏùº ÏûêÎèôÏû¨ÏÉù Ï†úÏïΩ Ïãú Î¨¥Ïãú */ }
    }

    // ---------- ÏûÖÎ†•/ÎçòÏßÄÍ∏∞ ----------
    let isDown = false, start = {x:0,y:0}, cur = {x:0,y:0};
    let stones = [];
    let skipCount = 0;
    let throwSkips = 0; // Ìïú Î≤à ÎçòÏßÄÍ∏∞ ÎèôÏïà ÌöüÏàò

    const GRAV = 900;
    const RESTITUTION = 0.55;
    const FRICTION_X = 0.985;
    const WATER_DRAG = 0.88;
    const MIN_SPEED = 40;

    canvas.addEventListener('mousedown', (e) => {
      isDown = true;
      start = getPos(e);
      cur = {...start};
      throwSkips = 0;
    });
    canvas.addEventListener('mousemove', (e) => {
      if (isDown) cur = getPos(e);
    });
    addEventListener('mouseup', () => {
      if (!isDown) return;
      isDown = false;

      const vx = (start.x - cur.x) * 3;
      const vy = (start.y - cur.y) * 3;

      stones.push({ x:start.x, y:start.y, r:8, vx, vy, alive:true, color:'#2a7de1' });
    });

    function getPos(e){
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    // ---------- Î£®ÌîÑ ----------
    let last = performance.now();
    function loop(now){
      const dt = Math.min(0.033, (now - last) / 1000);
      last = now;

      // Î¨ºÎ¶¨
      stones.forEach(s => {
        if (!s.alive) return;
        s.vy += GRAV * dt;
        s.x  += s.vx * dt;
        s.y  += s.vy * dt;

        if (s.y >= waterY) {
          if (s.vy > 0) {
            // Ïä§ÌÇµ Ïπ¥Ïö¥Ìä∏ & Ìö®Í≥ºÏùå
            skipCount++; throwSkips++;
            skipsEl.textContent = skipCount;
            ping();
          }
          s.y  = waterY - (s.y - waterY);
          s.vy = -Math.abs(s.vy) * RESTITUTION;
          s.vx *= WATER_DRAG;
        }

        s.vx *= FRICTION_X;

        const speed = Math.hypot(s.vx, s.vy);
        if (speed < MIN_SPEED && s.y >= waterY - 1) {
          s.alive = false;
          // Ïù¥Î≤à Ìà¨Ï≤ô Ï¢ÖÎ£å Ïãú, Î≤†Ïä§Ìä∏ Í∞±Ïã† Ï≤¥ÌÅ¨
          if (throwSkips > 0) {
            if (throwSkips > getBest()) {
              setBest(throwSkips);
              showToast(`New Best! ${throwSkips} skips üéâ`);
            } else {
              showToast(`${throwSkips} skips`);
            }
            throwSkips = 0;
          }
        }
      });

      draw();
      stones = stones.filter(s => s.alive || stones.length < 80);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ---------- Î†åÎçî ----------
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const grad = ctx.createLinearGradient(0,0,0,canvas.height);
      grad.addColorStop(0,'#bfe5ff'); grad.addColorStop(0.6,'#e8f6ff');
      ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#9dd6ff'; ctx.fillRect(0, waterY, canvas.width, canvas.height - waterY);

      if (isDown) {
        ctx.strokeStyle = 'rgba(0,0,0,0.6)'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.lineTo(cur.x, cur.y); ctx.stroke();
        ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(start.x, start.y, 4, 0, Math.PI*2); ctx.fill();
      }

      stones.forEach(s => {
        ctx.fillStyle = s.color;
        ctx.beginPath(); ctx.ellipse(s.x, s.y, s.r*1.2, s.r, 0, 0, Math.PI*2); ctx.fill();
      });
    }

    // ---------- ÌÜ†Ïä§Ìä∏ ----------
    let toastTimer;
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.opacity = 1;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.style.opacity = 0, 1200);
    }
  </script>
</body>
</html>
